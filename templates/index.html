<!DOCTYPE html>
<html>
<head>
    <title>Rasa Chatbot Training Data Upload</title>
    <link rel="stylesheet" type="text/css" href="./static/style.css">
</head>
<body>
   <div class="wrapper">
        <div class="container">

    <form id="upload-form" enctype="multipart/form-data">
        <span class="nb">1</span>
         <h2> Import Training Data :</h2>
        <label for="nlu_file">NLU File:</label>
        <input type="file" id="nlu_file" name="files[]" accept=".csv">
        <label for="stories_file">Stories File:</label>
        <input type="file" id="stories_file" name="files[]" accept=".csv">
        <label for="rules_file">Rules File:</label>
        <input type="file" id="rules_file" name="files[]" accept=".csv">
        <button type="submit" class="btns" >Upload</button>

    </form>

    <form id="generate-domain-form">
        <span class="nb">2</span>

        <h2> Generate Domain File :</h2>
        <label for="expiration_time">Session Expiration Time:</label>
        <input type="number" id="expiration_time" name="expiration_time" required>
        <label for="responses">Responses File:</label>
        <input type="file" name="files[]" id="responses" multiple accept=".csv">
        <button type="submit" class="btns">Generate Domain</button>
    </form>

    <form id="train-model-form">
        <span class="nb">3</span>

        <h2> Train Rasa Model :</h2>
        <button type="submit" class="btns">Train Model</button>
    </form>
    <form id="api">
        <textarea id="content" name="content" rows="4" cols="50"></textarea>
        <button type="submit">call Api</button>
    </form>
    <div id="rasa-chat-widget" data-websocket-url="ws://localhost:5005"></div>
    </div>
    <div id="response">
    </div>
    <div id="loader">
        <div class="jumping-dots-loader"> <span></span> <span></span> <span></span> </div>
        <div class="moving-gradient"></div>
    </div>
   </div>
<script src="https://unpkg.com/@rasahq/rasa-chat" type="application/javascript"></script><script src="https://cdn.jsdelivr.net/npm/rasa-webchat@1.0.0/dist/index.js"></script>
    <script>

          let loader = document.getElementById("loader")
         // api call =======================
const url = 'http://localhost:5005/model/train';

const form = document.getElementById('api'); // form's ID

form.addEventListener('submit', async function(event) {
  event.preventDefault();

  const textarea = document.getElementById('content'); // textarea's ID
  const trainingData = textarea.value;

  const requestOptions = {
    method: 'POST',
    headers: {
      'Content-Type': 'application/yaml'
    },
    body: trainingData
  };

  try {
    const response = await fetch(url, requestOptions);

    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }

    const responseData = await response.json();
    console.log('Training response:', responseData);
    // Handle the response as needed
  } catch (error) {
    console.error('Error:', error);
    // Handle errors
  }
});

        // Function to handle form submission
        function handleSubmitForm(formId, url) {
            const form = document.getElementById(formId);
            form.addEventListener("submit", function(event) {
                event.preventDefault(); // Prevent default form submission
                    if(formId =="train-model-form"){
                    loader.style.display = "block";
                }
                // Send form data using AJAX
                const formData = new FormData(form);
                fetch(url, {
                    method: "POST",
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                if(formId =="train-model-form" && data){
                    loader.style.display = "none";
                }
                    console.log("Server response:", data);
                    // Handle the response as needed
                    // Update the response element with the received response
                const responseElement = document.getElementById("response");

                const p = document.createElement('p');
                p.textContent = "âœ… "+data.message;
                responseElement.appendChild(p);
                })
                .catch(error => {
                    console.error("Error:", error);
                    // Handle errors
                });
            });
        }

        // Call the function for each form
        handleSubmitForm("upload-form", "/upload");
        handleSubmitForm("generate-domain-form", "/generate_domain");
        handleSubmitForm("train-model-form", "/model/train");

         WebChat.default.init({
            selector: "#rasa-chat-widget",
            initPayload: "/get_started",  // Initial payload for the Rasa chatbot
            socketUrl: "http://0.0.0.0:5005",
            customData: { "language": "en" },  // Customize as needed

        });
    </script>
</body>
</html>
